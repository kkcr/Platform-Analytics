<html>
<head>
    <style>
        h4 {
            font-weight: bold;
        }
        li {
            margin-left: 5%;
        }
        p {
            margin-left: 2%;
        }
        table {
            margin-left: 2%;
            border-collapse: collapse;
            width: 95%;
        }
        th, td {
            border: 1px solid #ccc;
            padding: 8px;
            text-align: left;
        }
        th {
            background-color: #f3f3f3;
        }
    </style>
</head>
<body>
    <div class="maincon">
        <h3>Bucket Groups</h3>
        <p>
            Bucket groups are used to recategorize data so it can be used as a breakdown, for example by grouping 
            a range of values into discrete buckets.
        </p>

        <h4>Why Should You Use a Bucket Group?</h4>
        <p><b>Answer:</b> Bucket Groups let you implement a Breakdown on a continuous attribute.</p>

        <p>
            Attributes such as <b>Priority</b>, <b>State</b>, and <b>Assignment Group</b> are 
            <i>Categorical</i> (finite values).  
            Attributes such as <b>Age</b>, <b>Cost</b>, and <b>Percent Complete</b> are 
            <i>Continuous</i> (values within a range).
        </p>

        <p>
            Continuous attributes cannot directly be used as breakdowns. For example, using <b>Percent Complete</b> 
            could result in 100+ elements — not practical.  
            <b>Bucket Groups solve this issue by organizing continuous values into categories.</b>
        </p>

        <h4>Example: Incident Age</h4>
        <p>Instead of infinite breakdown elements, create an <b>Age Range</b> breakdown with buckets such as:</p>
        <ul>
            <li>Less than 1 day</li>
            <li>1-3 days</li>
            <li>4-7 days</li>
            <li>8-12 days</li>
            <li>12+ days</li>
        </ul>

        <h4>Example: Reassignment Count</h4>
        <p>
            To analyze incidents by <b>Reassignment Count</b>, group it into categories such as:
        </p>
        <ul>
            <li>None</li>
            <li>1-3</li>
            <li>4+</li>
        </ul>
        <p>
            These ranges don’t exist in the source table, so you create a <b>Bucket Group</b> to define 
            and use them as breakdown elements.
        </p>

        <h4>Use Buckets as Breakdown Elements</h4>
        <p>
            Bucket Groups and their elements are stored in the Buckets table, which can be used 
            as a facts table for a Breakdown Source.
        </p>

        <h4>High-level Steps to Configure and Use Bucket Groups</h4>
        <ul>
            <li>Create a Bucket Group and define the desired buckets.</li>
            <li>Create a Breakdown Source using the Bucket Group as the Facts table.</li>
            <li>If needed, create a script to map process table data into the correct bucket.</li>
            <li>Create a Breakdown (if one doesn’t exist) and map it to the process table.</li>
            <li>Collect data for the new Breakdown.</li>
        </ul>

        <h3>Performance Analytics Scripts</h3>
        <p>
            Performance Analytics (PA) scripts are JavaScript-based and run during data collection. 
            They execute for each row in the Indicator source and use the ServiceNow API.
        </p>
        <ul>
            <li>Scripts are executed during data collection.</li>
            <li>They can be used for <b>Scripted Indicators</b> or <b>Scripted Mappings</b>.</li>
        </ul>

        <h4>Use Cases</h4>
        <ul>
            <li><b>Breakdown Mapping Script:</b> Returns either a sys_id of a breakdown element or an integer to map to a bucket.</li>
            <li><b>Scripted Indicator:</b> Returns a calculated score derived from one or more fields.</li>
        </ul>
        <p>
            The same script can serve both purposes. Avoid GlideRecords or GlideAggregates as they may execute thousands of times during collection.
        </p>

        <h4>Script Configuration</h4>
        <p>Scripts have access to these variables:</p>
        <ul>
            <li><b>score_start</b>: start of collection period</li>
            <li><b>score_end</b>: end of collection period</li>
        </ul>
        <p>
            Facts table restrictions apply — only indicators using the same facts table can use a script.
        </p>

        <h4>Scripted Breakdown Mapping Example</h4>
        <ol>
            <li>Create an Age Ranges Bucket Group (0-1 days, 2-5 days, 6-30 days, 31-90 days, 90+ days).</li>
            <li>Create an Age Breakdown and Breakdown Source from the Bucket Group.</li>
            <li>Create a script <i>Incident.Age.Days</i> that calculates incident age in days.</li>
            <li>Map the script output into the appropriate bucket during data collection.</li>
        </ol>

        <h4>Scripted Indicator Example</h4>
        <p>
            Example: <b>Summed age of last update of open incidents</b> - a script calculates the hours since last update 
            and the aggregation SUM returns the final score.
        </p>

        <h4>Tips & Best Practices</h4>
        <ul>
            <li>Test scripts using <b>System Definition > Scripts - Background</b>.</li>
            <li>Heavy scripts may impact memory and cause long collection jobs.</li>
            <li>Use scripts only when necessary (e.g., date calculations, custom aggregations).</li>
            <li>Reference <b>score_start</b> and <b>score_end</b> variables where possible.</li>
        </ul>

        <h3>Data Collection - Default Limits</h3>
        <p>
            Default properties safeguard against performance issues. These are configured under 
            <b>Performance Analytics > System > Properties</b>.
        </p>
        <table>
            <tr>
                <th>Property</th>
                <th>Description</th>
                <th>Default Value</th>
            </tr>
            <tr>
                <td>com.snc.pa.dc.script_timeout</td>
                <td>Max script runtime before being skipped.</td>
                <td>30 seconds</td>
            </tr>
            <tr>
                <td>com.snc.pa.dc.hsql.max_row_count_indicator_source</td>
                <td>Max records a job can collect from one indicator source.</td>
                <td>1,000,000</td>
            </tr>
            <tr>
                <td>com.snc.pa.dc.hsql.max_breakdown_elements_limit</td>
                <td>Max breakdown elements from a source.</td>
                <td>-1 (no limit)</td>
            </tr>
            <tr>
                <td>com.snc.pa.dc.max_error_count</td>
                <td>Max errors allowed per collection job.</td>
                <td>500</td>
            </tr>
            <tr>
                <td>com.snc.pa.dc.hsql.max_breakdown_elements_level2_limit</td>
                <td>Max elements from combining two breakdowns.</td>
                <td>-1 (no limit)</td>
            </tr>
            <tr>
                <td>com.snc.pa.dc.max_records</td>
                <td>Max records stored in Snapshots [pa_snapshots] table per job.</td>
                <td>5000</td>
            </tr>
        </table>

        <h4>Indicator-Level Data Retention</h4>
        <p>
            Global properties define default retention for <i>pa_scores_l1</i>, <i>pa_scores_l2</i>, 
            and <i>pa_snapshots</i>.  
            Indicators can override retention by selecting <b>Override collection periods</b> 
            in their settings.
        </p>

        <h4>Exceeding Breakdown Limits</h4>
        <p>
            Too many breakdown elements can cause memory and dashboard performance issues.  
            If limits are exceeded:
        </p>
        <ul>
            <li>The breakdown source is disabled and skipped during collection.</li>
            <li>A warning appears in the Data Collection Job Log and Diagnostics output.</li>
            <li>Use <b>Breakdown exclusions</b> or <b>Bucket Groups</b> to reduce elements.</li>
        </ul>
    </div>
</body>
</html>
